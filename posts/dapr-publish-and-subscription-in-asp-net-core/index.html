<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>ASP.NET Core 中使用 Dapr 发布订阅 | fissssssh</title><meta name=keywords content="C#,ASP.NET Core,dapr,dotnet"><meta name=description content="定义 subpub 组件 我们使用 Dapr 初始化时安装的 redis 作为 pubsub 的实现
创建文件 ~/.dapr/components/pubsub.yaml （Windows 用户为 %USERPROFILE%\.dapr\components\pubsub.yaml ），内容如下
Dapr 初始化后 ~/.dapr/components 文件夹会自动创建，里面有一个 statestore.yaml 的组件定义。如果没有该文件夹也不用担心，手动创建即可
apiVersion: dapr.io/v1alpha1 kind: Component metadata: name: pubsub spec: type: pubsub.redis version: v1 metadata: - name: redisHost value: localhost:6379 - name: redisPassword value: &#34;&#34; 创建项目 创建 ASP.NET Core WebAPI 项目
$ dotnet new webapi --no-openapi --no-https 安装 Dapr SDK
dotnet CLI
$ dotnet add package Dapr.AspNetCore 程序包管理器控制台
Install-Package Dapr.AspNetCore 也可以在 Visual Studio 的 Nuget 包管理器中搜索安装"><meta name=author content><link rel=canonical href=https://blog.fissssssh.com/posts/dapr-publish-and-subscription-in-asp-net-core/><link crossorigin=anonymous href=/assets/css/stylesheet.css rel="preload stylesheet" as=style><link rel=icon href=https://blog.fissssssh.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://blog.fissssssh.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://blog.fissssssh.com/favicon-32x32.png><link rel=apple-touch-icon href=https://blog.fissssssh.com/apple-touch-icon.png><link rel=mask-icon href=https://blog.fissssssh.com/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link rel=stylesheet href="https://fonts.googleapis.com/css?family=JetBrains+Mono&display=swap"><meta property="og:title" content="ASP.NET Core 中使用 Dapr 发布订阅"><meta property="og:description" content="定义 subpub 组件 我们使用 Dapr 初始化时安装的 redis 作为 pubsub 的实现
创建文件 ~/.dapr/components/pubsub.yaml （Windows 用户为 %USERPROFILE%\.dapr\components\pubsub.yaml ），内容如下
Dapr 初始化后 ~/.dapr/components 文件夹会自动创建，里面有一个 statestore.yaml 的组件定义。如果没有该文件夹也不用担心，手动创建即可
apiVersion: dapr.io/v1alpha1 kind: Component metadata: name: pubsub spec: type: pubsub.redis version: v1 metadata: - name: redisHost value: localhost:6379 - name: redisPassword value: &#34;&#34; 创建项目 创建 ASP.NET Core WebAPI 项目
$ dotnet new webapi --no-openapi --no-https 安装 Dapr SDK
dotnet CLI
$ dotnet add package Dapr.AspNetCore 程序包管理器控制台
Install-Package Dapr.AspNetCore 也可以在 Visual Studio 的 Nuget 包管理器中搜索安装"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.fissssssh.com/posts/dapr-publish-and-subscription-in-asp-net-core/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-12-14T22:25:34+08:00"><meta property="article:modified_time" content="2022-12-14T22:25:34+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="ASP.NET Core 中使用 Dapr 发布订阅"><meta name=twitter:description content="定义 subpub 组件 我们使用 Dapr 初始化时安装的 redis 作为 pubsub 的实现
创建文件 ~/.dapr/components/pubsub.yaml （Windows 用户为 %USERPROFILE%\.dapr\components\pubsub.yaml ），内容如下
Dapr 初始化后 ~/.dapr/components 文件夹会自动创建，里面有一个 statestore.yaml 的组件定义。如果没有该文件夹也不用担心，手动创建即可
apiVersion: dapr.io/v1alpha1 kind: Component metadata: name: pubsub spec: type: pubsub.redis version: v1 metadata: - name: redisHost value: localhost:6379 - name: redisPassword value: &#34;&#34; 创建项目 创建 ASP.NET Core WebAPI 项目
$ dotnet new webapi --no-openapi --no-https 安装 Dapr SDK
dotnet CLI
$ dotnet add package Dapr.AspNetCore 程序包管理器控制台
Install-Package Dapr.AspNetCore 也可以在 Visual Studio 的 Nuget 包管理器中搜索安装"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"文章","item":"https://blog.fissssssh.com/posts/"},{"@type":"ListItem","position":2,"name":"ASP.NET Core 中使用 Dapr 发布订阅","item":"https://blog.fissssssh.com/posts/dapr-publish-and-subscription-in-asp-net-core/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"ASP.NET Core 中使用 Dapr 发布订阅","name":"ASP.NET Core 中使用 Dapr 发布订阅","description":"定义 subpub 组件 我们使用 Dapr 初始化时安装的 redis 作为 pubsub 的实现\n创建文件 ~/.dapr/components/pubsub.yaml （Windows 用户为 %USERPROFILE%\\.dapr\\components\\pubsub.yaml ），内容如下\nDapr 初始化后 ~/.dapr/components 文件夹会自动创建，里面有一个 statestore.yaml 的组件定义。如果没有该文件夹也不用担心，手动创建即可\napiVersion: dapr.io/v1alpha1 kind: Component metadata: name: pubsub spec: type: pubsub.redis version: v1 metadata: - name: redisHost value: localhost:6379 - name: redisPassword value: \u0026#34;\u0026#34; 创建项目 创建 ASP.NET Core WebAPI 项目\n$ dotnet new webapi --no-openapi --no-https 安装 Dapr SDK\ndotnet CLI\n$ dotnet add package Dapr.AspNetCore 程序包管理器控制台\nInstall-Package Dapr.AspNetCore 也可以在 Visual Studio 的 Nuget 包管理器中搜索安装","keywords":["C#","ASP.NET Core","dapr","dotnet"],"articleBody":"定义 subpub 组件 我们使用 Dapr 初始化时安装的 redis 作为 pubsub 的实现\n创建文件 ~/.dapr/components/pubsub.yaml （Windows 用户为 %USERPROFILE%\\.dapr\\components\\pubsub.yaml ），内容如下\nDapr 初始化后 ~/.dapr/components 文件夹会自动创建，里面有一个 statestore.yaml 的组件定义。如果没有该文件夹也不用担心，手动创建即可\napiVersion: dapr.io/v1alpha1 kind: Component metadata: name: pubsub spec: type: pubsub.redis version: v1 metadata: - name: redisHost value: localhost:6379 - name: redisPassword value: \"\" 创建项目 创建 ASP.NET Core WebAPI 项目\n$ dotnet new webapi --no-openapi --no-https 安装 Dapr SDK\ndotnet CLI\n$ dotnet add package Dapr.AspNetCore 程序包管理器控制台\nInstall-Package Dapr.AspNetCore 也可以在 Visual Studio 的 Nuget 包管理器中搜索安装\n添加 Dapr 支持到 ASP.NET Core 框架\nProgram.cs\n- builder.Services.AddControllers(); + builder.Services.AddControllers().AddDapr(); app.MapControllers(); + app.MapSubscribeHandler(); 添加消息处理程序\nPubSubController.cs\nusing Dapr; using Microsoft.AspNetCore.Mvc; namespace pubsub { public class PubSubController : ControllerBase { private readonly ILogger _logger; public PubSubController(ILogger logger) { _logger = logger; } [Topic(\"pubsub\", \"Test\")] [HttpPost(\"test\")] public async Task SubscribeTest() { var sr = new StreamReader(HttpContext.Request.Body); var body = await sr.ReadToEndAsync(); _logger.LogInformation(\"received cloud event from Test: {message}\", body); return Ok(); } } } 使用 Dapr.AspNetCore 提供的 TopicAttribute 可以方便的订阅主题并关联到 API 接口，必须在管道中配置 app.MapSubscribeHandler()， 否则即使标注了 Topic 特性程序也不会订阅\n订阅主题的接口必须返回 HTTP 200 OK 状态码，否则 dapr 可能会视为消息推送不成功而进行重新推送，dapr 的消息推送规则为 AtLeastOnce，即至少一次\n测试订阅 使用 dapr 启动程序\n$ dapr run --app-id pubsubtest --app-port 5265 -- dotnet run --app-port 为应用程序的 http 端口，对于 ASP.NET Core 开发环境来说，一般在 Properties/launchSettings.json 中可以找到\n--app-id 为应用程序 id，同一组应用程序类似在发布订阅中类似消息队列中的消费者组，如果有多个程序的 app-id 相同，则只有一个程序实例能够收到消息\n使用 dapr 模拟发布\n$ dapr publish -i pubsubtest -p pubsub -t Test -d '{\"data\":\"this is a test message\"}' Event published successfully 观察第 1 步中程序的输出\n== APP == info: pubsub.PubSubController[0] == APP == received cloud event from Test: {\"data\":{\"data\":\"this is a test message\"},\"datacontenttype\":\"application/json\",\"id\":\"5d485363-1658-4771-8c25-a84615359dde\",\"pubsubname\":\"pubsub\",\"source\":\"pubsubtest\",\"specversion\":\"1.0\",\"time\":\"2022-12-15T01:17:10+08:00\",\"topic\":\"Test\",\"traceid\":\"00-363f742582302ed141396ce408dbacc0-4b6f5751d4039d75-01\",\"traceparent\":\"00-363f742582302ed141396ce408dbacc0-4b6f5751d4039d75-01\",\"tracestate\":\"\",\"type\":\"com.dapr.event.sent\"} 可以发现收到的数据是一个 JSON 格式数据， 其中 data 字段正是我们实际发送的内容\n{ \"data\": { \"data\": \"this is a test message\" }, \"datacontenttype\": \"application/json\", \"id\": \"5d485363-1658-4771-8c25-a84615359dde\", \"pubsubname\": \"pubsub\", \"source\": \"pubsubtest\", \"specversion\": \"1.0\", \"time\": \"2022-12-15T01:17:10+08:00\", \"topic\": \"Test\", \"traceid\": \"00-363f742582302ed141396ce408dbacc0-4b6f5751d4039d75-01\", \"traceparent\": \"00-363f742582302ed141396ce408dbacc0-4b6f5751d4039d75-01\", \"tracestate\": \"\", \"type\": \"com.dapr.event.sent\" } 这种数据格式在 dapr 中称为 CloudEvent，它记录了发送的内容，类型，主题和其他元信息，大部分情况下我们只需要 data 字段的内容，可以通过在 ASP.NET Core 管道中添加如下代码来对 CloudEvent 消息解包：\n+ app.UseCloudEvents(); app.MapControllers(); app.MapSubscribeHandler(); 修改代码后重新启动程序并发布测试消息，可以观察到以下输出\n== APP == info: pubsub.PubSubController[0] == APP == received cloud event from Test: {\"data\":\"this is a test message\"} 实际情况中不需要自己从 HttpContext.Request.Body 中读取数据，可以通过 ASP.NET Core 的模型绑定来做\n测试发布 修改现有代码\nprivate readonly ILogger _logger; + private readonly DaprClient _daprClient; - public PubSubController(ILogger logger) + public PubSubController(ILogger logger, DaprClient daprClient) { _logger = logger; + _daprClient = daprClient; } + [HttpPost(\"pub\")] + public async Task PublishTest() + { + await _daprClient.PublishEventAsync(\"pubsub\", \"Test\", new { data = \"this is a test publish message\" }); + return Ok(); + } 调用发布消息的 API 接口\n$ curl -XPOST http://localhost:5265/pub 观察程序输出\n== APP == info: pubsub.PubSubController[0] == APP == received cloud event from Test: {\"data\":\"this is a test publish message\"} 调用发布 API 后，程序发布了消息到 pubsub 组件的 Test 组件，而我们的程序又订阅了这个主题，所以会打印出我们发布出去的消息\n","wordCount":"409","inLanguage":"zh","datePublished":"2022-12-14T22:25:34+08:00","dateModified":"2022-12-14T22:25:34+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.fissssssh.com/posts/dapr-publish-and-subscription-in-asp-net-core/"},"publisher":{"@type":"Organization","name":"fissssssh","logo":{"@type":"ImageObject","url":"https://blog.fissssssh.com/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://blog.fissssssh.com/ accesskey=h title="fissssssh (Alt + H)">fissssssh</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://blog.fissssssh.com/posts/ title=文章><span>文章</span></a></li><li><a href=https://blog.fissssssh.com/archives/ title=归档><span>归档</span></a></li><li><a href=https://blog.fissssssh.com/tags/ title=标签><span>标签</span></a></li><li><a href=https://blog.fissssssh.com/links/ title=友链><span>友链</span></a></li><li><a href=https://blog.fissssssh.com/search/ title="搜索 (Alt + /)" accesskey=/><span>搜索</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>ASP.NET Core 中使用 Dapr 发布订阅</h1><div class=post-meta><span title='2022-12-14 22:25:34 +0800 +0800'>2022年12月14日</span>&nbsp;|&nbsp;<a href=https://github.com/fissssssh/fissssssh.github.io/edit/master/content/posts/dapr-publish-and-subscription-in-asp-net-core/index.md rel="noopener noreferrer" target=_blank>编辑</a></div></header><div class=post-content><h2 id=定义-subpub-组件>定义 subpub 组件<a hidden class=anchor aria-hidden=true href=#定义-subpub-组件>#</a></h2><p>我们使用 Dapr 初始化时安装的 redis 作为 pubsub 的实现</p><p>创建文件 <code>~/.dapr/components/pubsub.yaml</code> （Windows 用户为 <code>%USERPROFILE%\.dapr\components\pubsub.yaml</code> ），内容如下</p><blockquote><p>Dapr 初始化后 <code>~/.dapr/components</code> 文件夹会自动创建，里面有一个 <code>statestore.yaml</code> 的组件定义。如果没有该文件夹也不用担心，手动创建即可</p></blockquote><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#7ee787>apiVersion</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>dapr.io/v1alpha1</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>kind</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>Component</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>metadata</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>pubsub</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>spec</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>type</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>pubsub.redis</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>version</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>v1</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>metadata</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>- <span style=color:#7ee787>name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>redisHost</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#7ee787>value</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>localhost:6379</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>- <span style=color:#7ee787>name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>redisPassword</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#7ee787>value</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;&#34;</span><span style=color:#6e7681>
</span></span></span></code></pre></div><h2 id=创建项目>创建项目<a hidden class=anchor aria-hidden=true href=#创建项目>#</a></h2><ol><li><p>创建 ASP.NET Core WebAPI 项目</p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ dotnet new webapi --no-openapi --no-https
</span></span></code></pre></div></li><li><p>安装 Dapr SDK</p><ul><li><p>dotnet CLI</p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ dotnet add package Dapr.AspNetCore
</span></span></code></pre></div></li><li><p>程序包管理器控制台</p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-pwsh data-lang=pwsh><span style=display:flex><span>Install-Package Dapr.<span style=color:#79c0ff>AspNetCore</span>
</span></span></code></pre></div></li></ul><blockquote><p>也可以在 Visual Studio 的 Nuget 包管理器中搜索安装</p></blockquote></li><li><p>添加 Dapr 支持到 ASP.NET Core 框架</p><ul><li><p><strong>Program.cs</strong></p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span><span style=color:#ffa198;background-color:#490202>- builder.Services.AddControllers();
</span></span></span><span style=display:flex><span><span style=color:#ffa198;background-color:#490202></span><span style=color:#56d364;background-color:#0f5323>+ builder.Services.AddControllers().AddDapr();
</span></span></span><span style=display:flex><span><span style=color:#56d364;background-color:#0f5323></span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  app.MapControllers();
</span></span><span style=display:flex><span><span style=color:#56d364;background-color:#0f5323>+ app.MapSubscribeHandler();
</span></span></span></code></pre></div></li></ul></li><li><p>添加消息处理程序</p><ul><li><p><strong>PubSubController.cs</strong></p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#ff7b72>using</span> <span style=color:#ff7b72>Dapr</span>;
</span></span><span style=display:flex><span><span style=color:#ff7b72>using</span> <span style=color:#ff7b72>Microsoft.AspNetCore.Mvc</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>namespace</span> <span style=color:#ff7b72>pubsub</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>public</span> <span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>PubSubController</span> : ControllerBase
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>private</span> <span style=color:#ff7b72>readonly</span> ILogger&lt;PubSubController&gt; _logger;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>public</span> PubSubController(ILogger&lt;PubSubController&gt; logger)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            _logger = logger;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        [Topic(&#34;pubsub&#34;, &#34;Test&#34;)]
</span></span><span style=display:flex><span>        [HttpPost(&#34;test&#34;)]
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>public</span> <span style=color:#ff7b72>async</span> Task&lt;IActionResult&gt; SubscribeTest()
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>var</span> sr = <span style=color:#ff7b72>new</span> StreamReader(HttpContext.Request.Body);
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>var</span> body = <span style=color:#ff7b72>await</span> sr.ReadToEndAsync();
</span></span><span style=display:flex><span>            _logger.LogInformation(<span style=color:#a5d6ff>&#34;received cloud event from Test: {message}&#34;</span>, body);
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> Ok();
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><blockquote><p>使用 Dapr.AspNetCore 提供的 <code>TopicAttribute</code> 可以方便的订阅主题并关联到 API 接口，必须在管道中配置 <code>app.MapSubscribeHandler()</code>， 否则即使标注了 <code>Topic</code> 特性程序也不会订阅</p></blockquote><blockquote><p>订阅主题的接口必须返回 HTTP 200 OK 状态码，否则 dapr 可能会视为消息推送不成功而进行重新推送，dapr 的消息推送规则为 AtLeastOnce，即至少一次</p></blockquote></li></ul></li></ol><h2 id=测试订阅>测试订阅<a hidden class=anchor aria-hidden=true href=#测试订阅>#</a></h2><ol><li><p>使用 dapr 启动程序</p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ dapr run --app-id pubsubtest --app-port <span style=color:#a5d6ff>5265</span> -- dotnet run
</span></span></code></pre></div><blockquote><p><code>--app-port</code> 为应用程序的 http 端口，对于 ASP.NET Core 开发环境来说，一般在 <code>Properties/launchSettings.json</code> 中可以找到</p></blockquote><blockquote><p><code>--app-id</code> 为应用程序 id，同一组应用程序类似在发布订阅中类似消息队列中的消费者组，如果有多个程序的 app-id 相同，则只有一个程序实例能够收到消息</p></blockquote></li><li><p>使用 dapr 模拟发布</p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ dapr publish -i pubsubtest -p pubsub -t Test -d <span style=color:#a5d6ff>&#39;{&#34;data&#34;:&#34;this is a test message&#34;}&#39;</span>
</span></span><span style=display:flex><span>Event published successfully
</span></span></code></pre></div></li><li><p>观察第 1 步中程序的输出</p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>==</span> <span style=color:#79c0ff>APP</span> <span style=color:#ff7b72;font-weight:700>==</span> info: pubsub.PubSubController<span style=color:#ff7b72;font-weight:700>[</span>0<span style=color:#ff7b72;font-weight:700>]</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>==</span> <span style=color:#79c0ff>APP</span> <span style=color:#ff7b72;font-weight:700>==</span>       received cloud event from Test: <span style=color:#ff7b72;font-weight:700>{</span><span style=color:#a5d6ff>&#34;data&#34;</span>:<span style=color:#ff7b72;font-weight:700>{</span><span style=color:#a5d6ff>&#34;data&#34;</span>:<span style=color:#a5d6ff>&#34;this is a test message&#34;</span><span style=color:#ff7b72;font-weight:700>}</span>,<span style=color:#a5d6ff>&#34;datacontenttype&#34;</span>:<span style=color:#a5d6ff>&#34;application/json&#34;</span>,<span style=color:#a5d6ff>&#34;id&#34;</span>:<span style=color:#a5d6ff>&#34;5d485363-1658-4771-8c25-a84615359dde&#34;</span>,<span style=color:#a5d6ff>&#34;pubsubname&#34;</span>:<span style=color:#a5d6ff>&#34;pubsub&#34;</span>,<span style=color:#a5d6ff>&#34;source&#34;</span>:<span style=color:#a5d6ff>&#34;pubsubtest&#34;</span>,<span style=color:#a5d6ff>&#34;specversion&#34;</span>:<span style=color:#a5d6ff>&#34;1.0&#34;</span>,<span style=color:#a5d6ff>&#34;time&#34;</span>:<span style=color:#a5d6ff>&#34;2022-12-15T01:17:10+08:00&#34;</span>,<span style=color:#a5d6ff>&#34;topic&#34;</span>:<span style=color:#a5d6ff>&#34;Test&#34;</span>,<span style=color:#a5d6ff>&#34;traceid&#34;</span>:<span style=color:#a5d6ff>&#34;00-363f742582302ed141396ce408dbacc0-4b6f5751d4039d75-01&#34;</span>,<span style=color:#a5d6ff>&#34;traceparent&#34;</span>:<span style=color:#a5d6ff>&#34;00-363f742582302ed141396ce408dbacc0-4b6f5751d4039d75-01&#34;</span>,<span style=color:#a5d6ff>&#34;tracestate&#34;</span>:<span style=color:#a5d6ff>&#34;&#34;</span>,<span style=color:#a5d6ff>&#34;type&#34;</span>:<span style=color:#a5d6ff>&#34;com.dapr.event.sent&#34;</span><span style=color:#ff7b72;font-weight:700>}</span>
</span></span></code></pre></div><p>可以发现收到的数据是一个 JSON 格式数据， 其中 <code>data</code> 字段正是我们实际发送的内容</p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#7ee787>&#34;data&#34;</span>: { <span style=color:#7ee787>&#34;data&#34;</span>: <span style=color:#a5d6ff>&#34;this is a test message&#34;</span> },
</span></span><span style=display:flex><span>  <span style=color:#7ee787>&#34;datacontenttype&#34;</span>: <span style=color:#a5d6ff>&#34;application/json&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#7ee787>&#34;id&#34;</span>: <span style=color:#a5d6ff>&#34;5d485363-1658-4771-8c25-a84615359dde&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#7ee787>&#34;pubsubname&#34;</span>: <span style=color:#a5d6ff>&#34;pubsub&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#7ee787>&#34;source&#34;</span>: <span style=color:#a5d6ff>&#34;pubsubtest&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#7ee787>&#34;specversion&#34;</span>: <span style=color:#a5d6ff>&#34;1.0&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#7ee787>&#34;time&#34;</span>: <span style=color:#a5d6ff>&#34;2022-12-15T01:17:10+08:00&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#7ee787>&#34;topic&#34;</span>: <span style=color:#a5d6ff>&#34;Test&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#7ee787>&#34;traceid&#34;</span>: <span style=color:#a5d6ff>&#34;00-363f742582302ed141396ce408dbacc0-4b6f5751d4039d75-01&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#7ee787>&#34;traceparent&#34;</span>: <span style=color:#a5d6ff>&#34;00-363f742582302ed141396ce408dbacc0-4b6f5751d4039d75-01&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#7ee787>&#34;tracestate&#34;</span>: <span style=color:#a5d6ff>&#34;&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#7ee787>&#34;type&#34;</span>: <span style=color:#a5d6ff>&#34;com.dapr.event.sent&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>这种数据格式在 dapr 中称为 CloudEvent，它记录了发送的内容，类型，主题和其他元信息，大部分情况下我们只需要 <code>data</code> 字段的内容，可以通过在 ASP.NET Core 管道中添加如下代码来对 CloudEvent 消息解包：</p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span><span style=color:#56d364;background-color:#0f5323>+ app.UseCloudEvents();
</span></span></span><span style=display:flex><span><span style=color:#56d364;background-color:#0f5323></span>  app.MapControllers();
</span></span><span style=display:flex><span>  app.MapSubscribeHandler();
</span></span></code></pre></div><p>修改代码后重新启动程序并发布测试消息，可以观察到以下输出</p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>==</span> <span style=color:#79c0ff>APP</span> <span style=color:#ff7b72;font-weight:700>==</span> info: pubsub.PubSubController<span style=color:#ff7b72;font-weight:700>[</span>0<span style=color:#ff7b72;font-weight:700>]</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>==</span> <span style=color:#79c0ff>APP</span> <span style=color:#ff7b72;font-weight:700>==</span>       received cloud event from Test: <span style=color:#ff7b72;font-weight:700>{</span><span style=color:#a5d6ff>&#34;data&#34;</span>:<span style=color:#a5d6ff>&#34;this is a test message&#34;</span><span style=color:#ff7b72;font-weight:700>}</span>
</span></span></code></pre></div><blockquote><p>实际情况中不需要自己从 <code>HttpContext.Request.Body</code> 中读取数据，可以通过 ASP.NET Core 的模型绑定来做</p></blockquote></li></ol><h2 id=测试发布>测试发布<a hidden class=anchor aria-hidden=true href=#测试发布>#</a></h2><ol><li><p>修改现有代码</p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span>  private readonly ILogger&lt;PubSubController&gt; _logger;
</span></span><span style=display:flex><span><span style=color:#56d364;background-color:#0f5323>+ private readonly DaprClient _daprClient;
</span></span></span><span style=display:flex><span><span style=color:#56d364;background-color:#0f5323></span>
</span></span><span style=display:flex><span><span style=color:#ffa198;background-color:#490202>- public PubSubController(ILogger&lt;PubSubController&gt; logger)
</span></span></span><span style=display:flex><span><span style=color:#ffa198;background-color:#490202></span><span style=color:#56d364;background-color:#0f5323>+ public PubSubController(ILogger&lt;PubSubController&gt; logger, DaprClient daprClient)
</span></span></span><span style=display:flex><span><span style=color:#56d364;background-color:#0f5323></span>  {
</span></span><span style=display:flex><span>      _logger = logger;
</span></span><span style=display:flex><span><span style=color:#56d364;background-color:#0f5323>+     _daprClient = daprClient;
</span></span></span><span style=display:flex><span><span style=color:#56d364;background-color:#0f5323></span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#56d364;background-color:#0f5323>+ [HttpPost(&#34;pub&#34;)]
</span></span></span><span style=display:flex><span><span style=color:#56d364;background-color:#0f5323>+ public async Task&lt;IActionResult&gt; PublishTest()
</span></span></span><span style=display:flex><span><span style=color:#56d364;background-color:#0f5323>+ {
</span></span></span><span style=display:flex><span><span style=color:#56d364;background-color:#0f5323>+     await _daprClient.PublishEventAsync(&#34;pubsub&#34;, &#34;Test&#34;, new { data = &#34;this is a test publish message&#34; });
</span></span></span><span style=display:flex><span><span style=color:#56d364;background-color:#0f5323>+     return Ok();
</span></span></span><span style=display:flex><span><span style=color:#56d364;background-color:#0f5323>+ }
</span></span></span></code></pre></div></li><li><p>调用发布消息的 API 接口</p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ curl -XPOST http://localhost:5265/pub
</span></span></code></pre></div></li><li><p>观察程序输出</p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>==</span> <span style=color:#79c0ff>APP</span> <span style=color:#ff7b72;font-weight:700>==</span> info: pubsub.PubSubController<span style=color:#ff7b72;font-weight:700>[</span>0<span style=color:#ff7b72;font-weight:700>]</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>==</span> <span style=color:#79c0ff>APP</span> <span style=color:#ff7b72;font-weight:700>==</span>       received cloud event from Test: <span style=color:#ff7b72;font-weight:700>{</span><span style=color:#a5d6ff>&#34;data&#34;</span>:<span style=color:#a5d6ff>&#34;this is a test publish message&#34;</span><span style=color:#ff7b72;font-weight:700>}</span>
</span></span></code></pre></div><p>调用发布 API 后，程序发布了消息到 pubsub 组件的 Test 组件，而我们的程序又订阅了这个主题，所以会打印出我们发布出去的消息</p></li></ol></div><footer class=post-footer><ul class=post-tags><li><a href=https://blog.fissssssh.com/tags/c#/>C#</a></li><li><a href=https://blog.fissssssh.com/tags/asp.net-core/>ASP.NET Core</a></li><li><a href=https://blog.fissssssh.com/tags/dapr/>dapr</a></li><li><a href=https://blog.fissssssh.com/tags/dotnet/>dotnet</a></li></ul></footer><script>(function(){let t=localStorage.getItem("pref-theme");t?t=t==="dark"?"github-dark":"github-light":t=window.matchMedia("(prefers-color-scheme: dark)").matches?"github-dark":"github-light";const e=document.createElement("script");e.src="https://utteranc.es/client.js",e.crossorigin="anonymous",e.async=!0,e.setAttribute("repo","fissssssh/fissssssh.github.io"),e.setAttribute("issue-term","pathname"),e.setAttribute("label","Comment"),e.setAttribute("theme",t),document.body.appendChild(e)})()</script></article></main><footer class=footer><span>&copy; 2023 <a href=https://blog.fissssssh.com/>fissssssh</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>document.getElementById("theme-toggle").addEventListener("click",()=>{const e=document.querySelector(".utterances-frame"),t={type:"set-theme",theme:localStorage.getItem("pref-theme")==="light"?"github-dark":"github-light"};e?.contentWindow.postMessage(t,"https://utteranc.es")})</script><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="复制";function s(){t.innerHTML="已复制！",setTimeout(()=>{t.innerHTML="复制"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>