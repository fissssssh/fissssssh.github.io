<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>如何正确在 ASP.NET Core 中返回流 | fissssssh</title><meta name=keywords content="ASP.NET Core,CSharp"><meta name=description content="最近有位朋友说他在接口中使用 File(Stream stream, string contentType) 方法报错，报错内容是
2023-03-30 18:00:36.8882|ERROR|Microsoft.AspNetCore.Server.Kestrel|Connection id &#34;OHMPHOM94BVEL&#34;, Request id &#34;OHMPHOM94BVEL:00000004&#34;: An unhandled exception was thrown by the application. 大致推测是请求接口前或者接口后出的异常，也没有详细信息，于是要来了一份代码，代码（精简版）如下：
// ExcelDocument.cs public class ExcelDocument { public static Stream GetFileStream() { using var fs = new FileStream(&#34;appsettings.json&#34;, FileMode.Open, FileAccess.Read); var ms = new MemoryStream(); fs.CopyTo(ms); return ms; } } // HomeController.cs [HttpGet(&#34;GetFile&#34;)] public IActionResult GetFile() { var stream = ExcelDocument.GetFileStream(); // 原本是application/vnd.ms-excel， 我这里写测试返回的appsettings.json就换了一下 return File(stream, &#34;application/json&#34;); } 这段代码看着没啥问题，我试着请求了一下，果然有报错，我的报错如下："><meta name=author content><link rel=canonical href=https://blog.fissssssh.com/posts/how-to-return-stream-in-asp_net_core_webapi-correctly/><link crossorigin=anonymous href=/assets/css/stylesheet.css rel="preload stylesheet" as=style><link rel=icon href=https://blog.fissssssh.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://blog.fissssssh.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://blog.fissssssh.com/favicon-32x32.png><link rel=apple-touch-icon href=https://blog.fissssssh.com/apple-touch-icon.png><link rel=mask-icon href=https://blog.fissssssh.com/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link rel=stylesheet href="https://fonts.googleapis.com/css?family=JetBrains+Mono&display=swap"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css><meta property="og:title" content="如何正确在 ASP.NET Core 中返回流"><meta property="og:description" content="最近有位朋友说他在接口中使用 File(Stream stream, string contentType) 方法报错，报错内容是
2023-03-30 18:00:36.8882|ERROR|Microsoft.AspNetCore.Server.Kestrel|Connection id &#34;OHMPHOM94BVEL&#34;, Request id &#34;OHMPHOM94BVEL:00000004&#34;: An unhandled exception was thrown by the application. 大致推测是请求接口前或者接口后出的异常，也没有详细信息，于是要来了一份代码，代码（精简版）如下：
// ExcelDocument.cs public class ExcelDocument { public static Stream GetFileStream() { using var fs = new FileStream(&#34;appsettings.json&#34;, FileMode.Open, FileAccess.Read); var ms = new MemoryStream(); fs.CopyTo(ms); return ms; } } // HomeController.cs [HttpGet(&#34;GetFile&#34;)] public IActionResult GetFile() { var stream = ExcelDocument.GetFileStream(); // 原本是application/vnd.ms-excel， 我这里写测试返回的appsettings.json就换了一下 return File(stream, &#34;application/json&#34;); } 这段代码看着没啥问题，我试着请求了一下，果然有报错，我的报错如下："><meta property="og:type" content="article"><meta property="og:url" content="https://blog.fissssssh.com/posts/how-to-return-stream-in-asp_net_core_webapi-correctly/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-03-30T19:51:13+08:00"><meta property="article:modified_time" content="2023-03-30T19:51:13+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="如何正确在 ASP.NET Core 中返回流"><meta name=twitter:description content="最近有位朋友说他在接口中使用 File(Stream stream, string contentType) 方法报错，报错内容是
2023-03-30 18:00:36.8882|ERROR|Microsoft.AspNetCore.Server.Kestrel|Connection id &#34;OHMPHOM94BVEL&#34;, Request id &#34;OHMPHOM94BVEL:00000004&#34;: An unhandled exception was thrown by the application. 大致推测是请求接口前或者接口后出的异常，也没有详细信息，于是要来了一份代码，代码（精简版）如下：
// ExcelDocument.cs public class ExcelDocument { public static Stream GetFileStream() { using var fs = new FileStream(&#34;appsettings.json&#34;, FileMode.Open, FileAccess.Read); var ms = new MemoryStream(); fs.CopyTo(ms); return ms; } } // HomeController.cs [HttpGet(&#34;GetFile&#34;)] public IActionResult GetFile() { var stream = ExcelDocument.GetFileStream(); // 原本是application/vnd.ms-excel， 我这里写测试返回的appsettings.json就换了一下 return File(stream, &#34;application/json&#34;); } 这段代码看着没啥问题，我试着请求了一下，果然有报错，我的报错如下："><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"文章","item":"https://blog.fissssssh.com/posts/"},{"@type":"ListItem","position":2,"name":"如何正确在 ASP.NET Core 中返回流","item":"https://blog.fissssssh.com/posts/how-to-return-stream-in-asp_net_core_webapi-correctly/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"如何正确在 ASP.NET Core 中返回流","name":"如何正确在 ASP.NET Core 中返回流","description":"最近有位朋友说他在接口中使用 File(Stream stream, string contentType) 方法报错，报错内容是\n2023-03-30 18:00:36.8882|ERROR|Microsoft.AspNetCore.Server.Kestrel|Connection id \u0026#34;OHMPHOM94BVEL\u0026#34;, Request id \u0026#34;OHMPHOM94BVEL:00000004\u0026#34;: An unhandled exception was thrown by the application. 大致推测是请求接口前或者接口后出的异常，也没有详细信息，于是要来了一份代码，代码（精简版）如下：\n// ExcelDocument.cs public class ExcelDocument { public static Stream GetFileStream() { using var fs = new FileStream(\u0026#34;appsettings.json\u0026#34;, FileMode.Open, FileAccess.Read); var ms = new MemoryStream(); fs.CopyTo(ms); return ms; } } // HomeController.cs [HttpGet(\u0026#34;GetFile\u0026#34;)] public IActionResult GetFile() { var stream = ExcelDocument.GetFileStream(); // 原本是application/vnd.ms-excel， 我这里写测试返回的appsettings.json就换了一下 return File(stream, \u0026#34;application/json\u0026#34;); } 这段代码看着没啥问题，我试着请求了一下，果然有报错，我的报错如下：","keywords":["ASP.NET Core","CSharp"],"articleBody":"最近有位朋友说他在接口中使用 File(Stream stream, string contentType) 方法报错，报错内容是\n2023-03-30 18:00:36.8882|ERROR|Microsoft.AspNetCore.Server.Kestrel|Connection id \"OHMPHOM94BVEL\", Request id \"OHMPHOM94BVEL:00000004\": An unhandled exception was thrown by the application. 大致推测是请求接口前或者接口后出的异常，也没有详细信息，于是要来了一份代码，代码（精简版）如下：\n// ExcelDocument.cs public class ExcelDocument { public static Stream GetFileStream() { using var fs = new FileStream(\"appsettings.json\", FileMode.Open, FileAccess.Read); var ms = new MemoryStream(); fs.CopyTo(ms); return ms; } } // HomeController.cs [HttpGet(\"GetFile\")] public IActionResult GetFile() { var stream = ExcelDocument.GetFileStream(); // 原本是application/vnd.ms-excel， 我这里写测试返回的appsettings.json就换了一下 return File(stream, \"application/json\"); } 这段代码看着没啥问题，我试着请求了一下，果然有报错，我的报错如下：\nfail: Microsoft.AspNetCore.Server.Kestrel[13] Connection id \"0HMPH2LG4PQU0\", Request id \"0HMPH2LG4PQU0:00000004\": An unhandled exception was thrown by the application. System.InvalidOperationException: Response Content-Length mismatch: too few bytes written (0 of 151). 注意错误中多了一行 System.InvalidOperationException: Response Content-Length mismatch: too few bytes written (0 of 151).，这很关键，说明之前的日志模板没有输出异常的详细信息\n根据异常信息来看，响应头 Content-Length 设置为了 151 ，但是 body 中没有写入数据（写入字节数为 0），大致能猜到是没读取到流的内容，为什么呢？创建的 MemoryStream 也没有关闭,答案就在于Stream.CopyTo(Steam)这个方法，让我们来看一下官方文档对这个函数的定义\nReads the bytes from the current stream and writes them to another stream. Both streams positions are advanced by the number of bytes copied. 恍然大悟！原来 CopyTo 会将流的 Position 移动，怪不得读取不到数据\n解决这个问题也很简单，就是在 CopyTo 方法之后将流的指针移动到开始位置（流的最前端）\n// ExcelDocument.cs public class ExcelDocument { public static Stream GetFileStream() { using var fs = new FileStream(\"appsettings.json\", FileMode.Open, FileAccess.Read); var ms = new MemoryStream(); fs.CopyTo(ms); ms.Seek(0, SeekOrigin.Begin); return ms; } } $ curl http://localhost:5125/Home/GetFile { \"Logging\": { \"LogLevel\": { \"Default\": \"Information\", \"Microsoft.AspNetCore\": \"Warning\" } }, \"AllowedHosts\": \"*\" } 总结下来有两个问题：\n对 Stream.CopyTo 这个方法的不了解，未能在编码的时候注意到并避免（主要原因） 日志记录模板没有配置显示异常详细信息而只显示了 Message，让我们没有足够的报错信息去排查错误 ","wordCount":"205","inLanguage":"zh","datePublished":"2023-03-30T19:51:13+08:00","dateModified":"2023-03-30T19:51:13+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.fissssssh.com/posts/how-to-return-stream-in-asp_net_core_webapi-correctly/"},"publisher":{"@type":"Organization","name":"fissssssh","logo":{"@type":"ImageObject","url":"https://blog.fissssssh.com/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://blog.fissssssh.com/ accesskey=h title="fissssssh (Alt + H)">fissssssh</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://blog.fissssssh.com/posts/ title=文章><span>文章</span></a></li><li><a href=https://blog.fissssssh.com/archives/ title=归档><span>归档</span></a></li><li><a href=https://blog.fissssssh.com/tags/ title=标签><span>标签</span></a></li><li><a href=https://blog.fissssssh.com/links/ title=友链><span>友链</span></a></li><li><a href=https://blog.fissssssh.com/search/ title="搜索 (Alt + /)" accesskey=/><span>搜索</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>如何正确在 ASP.NET Core 中返回流</h1><div class=post-meta><span title='2023-03-30 19:51:13 +0800 +0800'>2023年3月30日</span>&nbsp;|&nbsp;<a href=https://github.com/fissssssh/fissssssh.github.io/edit/master/content/posts/how-to-return-stream-in-asp_net_core_webapi-correctly.md rel="noopener noreferrer" target=_blank>编辑</a></div></header><div class=post-content><p>最近有位朋友说他在接口中使用 <code>File(Stream stream, string contentType)</code> 方法报错，报错内容是</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>2023-03-30 18:00:36.8882|ERROR|Microsoft.AspNetCore.Server.Kestrel|Connection id <span style=color:#f1fa8c>&#34;OHMPHOM94BVEL&#34;</span>, Request id <span style=color:#f1fa8c>&#34;OHMPHOM94BVEL:00000004&#34;</span>: An unhandled exception was thrown by the application.
</span></span></code></pre></div><p>大致推测是请求接口前或者接口后出的异常，也没有详细信息，于是要来了一份代码，代码（精简版）如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c# data-lang=c#><span style=display:flex><span><span style=color:#6272a4>// ExcelDocument.cs</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>public</span> <span style=color:#ff79c6>class</span> <span style=color:#50fa7b>ExcelDocument</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>public</span> <span style=color:#ff79c6>static</span> Stream GetFileStream()
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>using</span> var fs = <span style=color:#ff79c6>new</span> FileStream(<span style=color:#f1fa8c>&#34;appsettings.json&#34;</span>, FileMode.Open, FileAccess.Read);
</span></span><span style=display:flex><span>        <span style=color:#8be9fd>var</span> ms = <span style=color:#ff79c6>new</span> MemoryStream();
</span></span><span style=display:flex><span>        fs.CopyTo(ms);
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> ms;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4>// HomeController.cs</span>
</span></span><span style=display:flex><span><span style=color:#50fa7b>
</span></span></span><span style=display:flex><span><span style=color:#50fa7b>[HttpGet(&#34;GetFile&#34;)]</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>public</span> IActionResult GetFile()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#8be9fd>var</span> stream = ExcelDocument.GetFileStream();
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 原本是application/vnd.ms-excel， 我这里写测试返回的appsettings.json就换了一下</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> File(stream, <span style=color:#f1fa8c>&#34;application/json&#34;</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>这段代码看着没啥问题，我试着请求了一下，果然有报错，我的报错如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>fail: Microsoft.AspNetCore.Server.Kestrel<span style=color:#ff79c6>[</span>13<span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span>      Connection id <span style=color:#f1fa8c>&#34;0HMPH2LG4PQU0&#34;</span>, Request id <span style=color:#f1fa8c>&#34;0HMPH2LG4PQU0:00000004&#34;</span>: An unhandled exception was thrown by the application.
</span></span><span style=display:flex><span>      System.InvalidOperationException: Response Content-Length mismatch: too few bytes written <span style=color:#ff79c6>(</span><span style=color:#bd93f9>0</span> of 151<span style=color:#ff79c6>)</span>.
</span></span></code></pre></div><p>注意错误中多了一行 <code>System.InvalidOperationException: Response Content-Length mismatch: too few bytes written (0 of 151).</code>，这很关键，说明之前的日志模板没有输出异常的详细信息</p><p>根据异常信息来看，响应头 <code>Content-Length</code> 设置为了 <code>151</code> ，但是 body 中没有写入数据（写入字节数为 <code>0</code>），大致能猜到是没读取到流的内容，为什么呢？创建的 <code>MemoryStream</code> 也没有关闭,答案就在于<code>Stream.CopyTo(Steam)</code>这个方法，让我们来看一下<a href="https://learn.microsoft.com/en-us/dotnet/api/system.io.stream.copyto?f1url=%3FappId%3DDev16IDEF1%26l%3DZH-CN%26k%3Dk(System.IO.Stream.CopyTo)%3Bk(DevLang-csharp)%26rd%3Dtrue&amp;view=net-7.0">官方文档</a>对这个函数的定义</p><pre tabindex=0><code>Reads the bytes from the current stream and writes them to another stream. Both streams positions are advanced by the number of bytes copied.
</code></pre><p>恍然大悟！原来 <code>CopyTo</code> 会将流的 <code>Position</code> 移动，怪不得读取不到数据</p><p>解决这个问题也很简单，就是在 <code>CopyTo</code> 方法之后将流的指针移动到开始位置（流的最前端）</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-c# data-lang=c#><span style=display:flex><span><span style=color:#6272a4>// ExcelDocument.cs</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>public</span> <span style=color:#ff79c6>class</span> <span style=color:#50fa7b>ExcelDocument</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>public</span> <span style=color:#ff79c6>static</span> Stream GetFileStream()
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>using</span> var fs = <span style=color:#ff79c6>new</span> FileStream(<span style=color:#f1fa8c>&#34;appsettings.json&#34;</span>, FileMode.Open, FileAccess.Read);
</span></span><span style=display:flex><span>        <span style=color:#8be9fd>var</span> ms = <span style=color:#ff79c6>new</span> MemoryStream();
</span></span><span style=display:flex><span>        fs.CopyTo(ms);
</span></span><span style=display:flex;background-color:#3d3f4a><span>        ms.Seek(<span style=color:#bd93f9>0</span>, SeekOrigin.Begin);
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> ms;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ curl http://localhost:5125/Home/GetFile
</span></span><span style=display:flex><span><span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>  <span style=color:#f1fa8c>&#34;Logging&#34;</span>: <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>    <span style=color:#f1fa8c>&#34;LogLevel&#34;</span>: <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>      <span style=color:#f1fa8c>&#34;Default&#34;</span>: <span style=color:#f1fa8c>&#34;Information&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f1fa8c>&#34;Microsoft.AspNetCore&#34;</span>: <span style=color:#f1fa8c>&#34;Warning&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>}</span>,
</span></span><span style=display:flex><span>  <span style=color:#f1fa8c>&#34;AllowedHosts&#34;</span>: <span style=color:#f1fa8c>&#34;*&#34;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>总结下来有两个问题：</p><ol><li>对 <code>Stream.CopyTo</code> 这个方法的不了解，未能在编码的时候注意到并避免（主要原因）</li><li>日志记录模板没有配置显示异常详细信息而只显示了 <code>Message</code>，让我们没有足够的报错信息去排查错误</li></ol></div><footer class=post-footer><ul class=post-tags><li><a href=https://blog.fissssssh.com/tags/asp.net-core/>ASP.NET Core</a></li><li><a href=https://blog.fissssssh.com/tags/csharp/>CSharp</a></li></ul></footer><script>(function(){let t=localStorage.getItem("pref-theme");t?t=t==="dark"?"github-dark":"github-light":t=window.matchMedia("(prefers-color-scheme: dark)").matches?"github-dark":"github-light";const e=document.createElement("script");e.src="https://utteranc.es/client.js",e.crossorigin="anonymous",e.async=!0,e.setAttribute("repo","fissssssh/fissssssh.github.io"),e.setAttribute("issue-term","pathname"),e.setAttribute("label","Comment"),e.setAttribute("theme",t),document.body.appendChild(e)})()</script></article></main><footer class=footer><span>&copy; 2023 <a href=https://blog.fissssssh.com/>fissssssh</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>document.getElementById("theme-toggle").addEventListener("click",()=>{const e=document.querySelector(".utterances-frame"),t={type:"set-theme",theme:localStorage.getItem("pref-theme")==="light"?"github-dark":"github-light"};e?.contentWindow.postMessage(t,"https://utteranc.es")})</script><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="复制";function s(){t.innerHTML="已复制！",setTimeout(()=>{t.innerHTML="复制"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>